<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CampusDude</title>

<style>
/* ===== GLOBAL ===== */
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:linear-gradient(135deg,#667eea,#764ba2);
}
.hidden{display:none}

/* ===== AUTH ===== */
.auth{
  max-width:360px;margin:80px auto;background:#fff;
  border-radius:16px;padding:24px;
  box-shadow:0 20px 40px rgba(0,0,0,.25)
}
.auth input{width:100%;padding:10px;margin-bottom:10px;border-radius:10px;border:1px solid #ddd}
.auth button{width:100%;padding:10px;border:none;border-radius:999px;font-weight:700;background:#4f46e5;color:#fff}
.link{text-align:center;font-size:13px;color:#4f46e5;cursor:pointer}

/* ===== HEADER ===== */
.header{text-align:center;padding:18px;color:#fff}
.header h1{margin:0;font-size:26px}
#userName{font-size:14px;opacity:.9;cursor:pointer;text-decoration:underline}

/* ===== TOP BAR ===== */
#topWrap{max-width:900px;margin:0 auto 12px}
#topLabel{color:#fff;font-weight:700;margin-bottom:6px}
#topTrack{height:18px;background:#fff;border-radius:999px;overflow:hidden}
#topBar{height:100%;width:0%;background:linear-gradient(135deg,#fde68a,#f59e0b)}

/* ===== MESSENGER ===== */
#chat{
  max-width:900px;
  margin:0 auto 20px;
  background:#ffffffdd;
  border-radius:16px;
  padding:14px;
}
#chat h3{margin:0 0 8px}
#messages{display:flex;flex-direction:column;gap:10px}
.msg{
  background:#f1f5f9;
  border-radius:12px;
  padding:8px 12px;
}
.msg small{opacity:.6}
.reply{
  margin-left:24px;
  background:#e0e7ff;
}
.msg button{
  border:none;
  background:none;
  color:#4f46e5;
  cursor:pointer;
  font-size:12px;
}
#chatInput{
  display:flex;
  gap:8px;
  margin-top:10px;
}
#chatInput input{
  flex:1;
  padding:8px;
  border-radius:999px;
  border:1px solid #ccc;
}
#chatInput button{
  padding:8px 16px;
  border:none;
  border-radius:999px;
  background:#4f46e5;
  color:#fff;
  font-weight:700;
}

/* ===== TABLE (UNCHANGED) ===== */
.wrap{overflow-x:auto;padding:0 12px 40px}
table{width:100%;min-width:1100px;border-collapse:collapse;background:#fff}
th,td{border:1px solid #e5e7eb;text-align:center}
th{background:#1f2937;color:#fff;padding:10px}
.day{background:#1f2937;color:#fff;font-weight:700;width:120px}
.cell{position:relative;height:120px}

/* ===== FOOTER ===== */
.footer{
  text-align:center;
  color:#e5e7eb;
  font-size:14px;
  margin:30px 0 20px;
  opacity:.85
}
</style>
</head>

<body>

<!-- AUTH -->
<div id="auth" class="auth hidden">
  <h2 id="authTitle">Login</h2>
  <input id="name" placeholder="Full name" class="hidden">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="submitAuth()">Continue</button>
  <div class="link" onclick="toggleAuth()" id="switchText">New here? Create account</div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div class="header">
    <h1>ðŸŽ“ CampusDude</h1>
    <div id="userName" onclick="editName()"></div>
  </div>

  <div id="topWrap">
    <div id="topLabel"></div>
    <div id="topTrack"><div id="topBar"></div></div>
  </div>

  <!-- MESSENGER -->
  <div id="chat">
    <h3>ðŸ’¬ Campus Wall</h3>
    <div id="messages"></div>
    <div id="chatInput">
      <input id="chatText" placeholder="Write somethingâ€¦">
      <button onclick="sendMessage()">Send</button>
    </div>
  </div>

  <!-- TIMETABLE -->
  <div class="wrap"><table id="table"></table></div>

  <div class="footer">
    ðŸ’¡ Idea & Developed by <b style="color:#fff">Talvi / Munmun</b>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
const supabase = createClient(
  "https://uwjnbbmbxxodiwrleozc.supabase.co",
  "sb_publishable_OINdv3b3c9-SRUr7ngWVlA_iPXM89of"
);

/* ===== AUTH + NAME ===== */
async function showUserName(){
  const {data:{user}}=await supabase.auth.getUser();
  userName.textContent=`Hi, ${user.user_metadata.full_name || "Student"} âœï¸`;
}
window.editName=async()=>{
  const {data:{user}}=await supabase.auth.getUser();
  const n=prompt("Enter name",user.user_metadata.full_name||"");
  if(!n)return;
  await supabase.auth.updateUser({data:{full_name:n}});
  showUserName();
};

/* ===== CHAT ===== */
let replyingTo=null;

async function loadMessages(){
  const {data}=await supabase
    .from("messages")
    .select("*")
    .order("created_at",{ascending:false})
    .limit(10);

  renderMessages(data.reverse());
}

function renderMessages(msgs){
  messages.innerHTML="";
  msgs.forEach(m=>{
    const d=document.createElement("div");
    d.className="msg";
    d.innerHTML=`
      <b>${m.user_name}</b><br>
      ${m.content}<br>
      <small>${new Date(m.created_at).toLocaleTimeString()}</small>
      <br><button onclick="reply('${m.id}','${m.user_name}')">Reply</button>
    `;
    messages.appendChild(d);
  });
}

window.reply=(id,name)=>{
  replyingTo=id;
  chatText.placeholder=`Replying to ${name}â€¦`;
};

window.sendMessage=async()=>{
  const {data:{user}}=await supabase.auth.getUser();
  if(!chatText.value)return;

  await supabase.from("messages").insert({
    user_id:user.id,
    user_name:user.user_metadata.full_name||"Student",
    content:chatText.value,
    parent_id:replyingTo
  });

  chatText.value="";
  replyingTo=null;
  chatText.placeholder="Write somethingâ€¦";
};

/* REALTIME */
supabase.channel("messages")
.on("postgres_changes",{event:"INSERT",schema:"public",table:"messages"},loadMessages)
.subscribe();

/* ===== INIT ===== */
const {data:{session}}=await supabase.auth.getSession();
if(session){
  auth.classList.add("hidden");
  app.classList.remove("hidden");
  showUserName();
  loadMessages();
}else{
  auth.classList.remove("hidden");
}
</script>

</body>
</html>

