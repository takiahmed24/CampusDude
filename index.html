<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CampusDude</title>

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:linear-gradient(135deg,#667eea,#764ba2);
}
.hidden{display:none}

/* AUTH */
.auth{
  max-width:360px;
  margin:80px auto;
  background:#fff;
  border-radius:16px;
  padding:24px;
  box-shadow:0 20px 40px rgba(0,0,0,.25);
}
.auth input{width:100%;padding:10px;margin-bottom:10px;border-radius:10px;border:1px solid #ddd}
.auth button{width:100%;padding:10px;border:none;border-radius:999px;font-weight:700;background:#4f46e5;color:#fff}
.link{text-align:center;font-size:13px;color:#4f46e5;cursor:pointer}

/* HEADER */
.header{text-align:center;padding:22px;font-size:28px;font-weight:800;color:#fff}

/* TOP BAR */
#topWrap{max-width:900px;margin:0 auto 16px}
#topLabel{color:#fff;font-weight:700;margin-bottom:6px}
#topTrack{height:18px;background:#fff;border-radius:999px;overflow:hidden}
#topBar{height:100%;width:0%;background:linear-gradient(135deg,#fde68a,#f59e0b);transition:width 1s linear}

/* TABLE */
.wrap{overflow-x:auto;padding:0 12px 40px}
table{width:100%;min-width:1100px;border-collapse:collapse;background:#fff}
th,td{border:1px solid #e5e7eb;text-align:center}
th{background:#1f2937;color:#fff;padding:10px}
.day{background:#1f2937;color:#fff;font-weight:700;width:120px}

/* SLOT */
.cell{position:relative;height:120px}
.gap{
  background:#ffd6d6;color:#7f1d1d;font-weight:700;
  height:100%;display:flex;align-items:center;justify-content:center;cursor:pointer
}

/* CLASS BLOCK */
.block{
  position:absolute;left:6px;right:6px;
  border-radius:12px;padding:8px;
  box-shadow:0 4px 10px rgba(0,0,0,.2);
  transition:height .6s linear;
  cursor:pointer;
}
.timer{
  display:inline-block;
  margin-top:6px;
  padding:4px 10px;
  background:#fff;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
}

/* STATES */
.block.next{outline:3px solid #f59e0b}
@keyframes pulseGlow{
  0%{box-shadow:0 0 0 0 rgba(245,158,11,.7)}
  70%{box-shadow:0 0 0 12px rgba(245,158,11,0)}
  100%{box-shadow:0 0 0 0 rgba(245,158,11,0)}
}
.block.active{animation:pulseGlow 1.8s infinite;z-index:5}

/* MODAL */
.modal{
  position:fixed;inset:0;
  background:rgba(0,0,0,.5);
  display:none;align-items:center;justify-content:center
}
.modal>div{
  background:#fff;border-radius:14px;padding:20px;width:340px
}
.modal input{width:100%;padding:8px;margin-bottom:8px}
.actions{display:flex;gap:8px}
.modal button{
  flex:1;padding:10px;border:none;border-radius:999px;
  background:#4f46e5;color:#fff;font-weight:700
}
</style>
</head>

<body>

<!-- AUTH -->
<div id="auth" class="auth hidden">
  <h2 id="authTitle">Login</h2>
  <input id="name" placeholder="Name" class="hidden">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="submitAuth()">Continue</button>
  <div class="link" onclick="toggleAuth()" id="switchText">New here? Create account</div>
  <div class="link" onclick="resetPass()">Forgot password?</div>
</div>

<!-- APP -->
<div id="app" class="hidden">
  <div class="header">ðŸŽ“ CampusDude</div>

  <div id="topWrap">
    <div id="topLabel"></div>
    <div id="topTrack"><div id="topBar"></div></div>
  </div>

  <div class="wrap"><table id="table"></table></div>
</div>

<!-- MODAL -->
<div class="modal" id="modal">
  <div>
    <h3 id="modalTitle"></h3>
    <input id="mTitle" placeholder="Class name">
    <input id="mSection" placeholder="Section (optional)">
    <input id="mRoom" placeholder="Room (optional)">
    <input id="mStart" type="time">
    <input id="mEnd" type="time">
    <div class="actions">
      <button onclick="saveClass()">Save</button>
      <button onclick="deleteClass()">Delete</button>
      <button onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

/* SUPABASE */
const supabase=createClient(
  "https://uwjnbbmbxxodiwrleozc.supabase.co",
  "sb_publishable_OINdv3b3c9-SRUr7ngWVlA_iPXM89of"
);

/* AUTH */
let mode="login";
window.toggleAuth=()=>{
  mode=mode==="login"?"signup":"login";
  authTitle.textContent=mode==="login"?"Login":"Create account";
  name.classList.toggle("hidden",mode==="login");
  switchText.textContent=mode==="login"
    ?"New here? Create account":"Already have an account?";
};
window.submitAuth=async()=>{
  if(mode==="signup"){
    const {error}=await supabase.auth.signUp({
      email:email.value,password:password.value,
      options:{data:{full_name:name.value}}
    });
    if(error) return alert(error.message);
    toggleAuth(); return;
  }
  const {error}=await supabase.auth.signInWithPassword({
    email:email.value,password:password.value
  });
  if(error) return alert(error.message);
  init();
};
window.resetPass=async()=>{
  await supabase.auth.resetPasswordForEmail(email.value,{redirectTo:location.origin});
  alert("Reset email sent");
};

/* CONFIG */
const DAYS=["Sunday","Monday","Tuesday","Wednesday","Thursday"];
const SLOTS=[["08:00","10:20"],["10:20","12:40"],["12:40","14:10"],["14:40","16:10"]];
let classes=[],active=null,activeSlot=null;

/* HELPERS */
const toMin=t=>{const[a,b]=t.split(":").map(Number);return a*60+b};
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const fmt=s=>{
  const d=Math.floor(s/86400);
  const h=Math.floor((s%86400)/3600);
  const m=Math.floor((s%3600)/60);
  const sec=Math.floor(s%60);
  return (d?d+"d ":"")+(h?h+"h ":"")+m+"m "+sec+"s";
};
function colorFromSection(s){
  if(!s) return "#e5e7eb";
  let h=0;for(let c of s)h=c.charCodeAt(0)+((h<<5)-h);
  const c=["#c7d2fe","#bbf7d0","#fde68a","#fecaca","#ddd6fe","#bae6fd"];
  return c[Math.abs(h)%c.length];
}

/* DAY-AWARE NEXT OCCURRENCE */
function nextClassStartDate(cls){
  const now=new Date();
  const today=now.getDay();
  const classDay=DAYS.indexOf(cls.day);
  let diff=classDay-today;
  if(diff<0) diff+=7;

  const d=new Date(now);
  d.setDate(now.getDate()+diff);
  const [h,m]=cls.start_time.split(":").map(Number);
  d.setHours(h,m,0,0);

  if(diff===0 && d<=now) d.setDate(d.getDate()+7);
  return d;
}

/* INIT */
async function init(){
  auth.classList.add("hidden");
  app.classList.remove("hidden");
  load();
}
const {data:{session}}=await supabase.auth.getSession();
session?init():auth.classList.remove("hidden");

/* LOAD */
async function load(){
  const {data:{user}}=await supabase.auth.getUser();
  const {data}=await supabase.from("classes").select("*").eq("user_id",user.id);
  classes=data||[];
  render();
}

/* RENDER */
function render(){
  table.innerHTML=`<tr><th>Day</th>${SLOTS.map(s=>`<th>${s[0]}â€“${s[1]}</th>`).join("")}</tr>`;
  DAYS.forEach(day=>{
    const tr=document.createElement("tr");
    tr.innerHTML=`<td class="day">${day}</td>`;
    SLOTS.forEach(([ss,se])=>{
      const td=document.createElement("td");
      const c=classes.find(x=>x.day===day&&toMin(x.end_time)>toMin(ss)&&toMin(x.start_time)<toMin(se));
      if(!c){
        const g=document.createElement("div");
        g.className="gap";g.textContent="gap";
        g.onclick=()=>openNew({day,start:ss,end:se});
        td.appendChild(g);
      }else{
        const cs=toMin(c.start_time),ce=toMin(c.end_time);
        const top=((Math.max(cs,toMin(ss))-toMin(ss))/(toMin(se)-toMin(ss)))*100;
        const h=((Math.min(ce,toMin(se))-Math.max(cs,toMin(ss)))/(toMin(se)-toMin(ss)))*100;
        td.innerHTML=`
          <div class="cell">
            <div class="block"
              data-id="${c.id}"
              data-day="${c.day}"
              data-start="${c.start_time}"
              data-end="${c.end_time}"
              data-slot-start="${ss}"
              data-slot-end="${se}"
              style="top:${top}%;height:${h}%;background:${c.color}">
              <b>${c.title}</b><br>
              ${c.section?`[${c.section}]<br>`:""}
              ${c.room?`Room: ${c.room}`:""}
              <div class="timer"></div>
            </div>
          </div>`;
        td.onclick=()=>openEdit(c);
      }
      tr.appendChild(td);
    });
    table.appendChild(tr);
  });
}

/* LIVE LOOP */
setInterval(()=>{
  const now=new Date();
  let next=null;

  document.querySelectorAll(".block").forEach(b=>{
    const cls={
      day:b.dataset.day,
      start_time:b.dataset.start,
      end_time:b.dataset.end
    };
    const start=nextClassStartDate(cls);
    const end=new Date(start.getTime()+ (toMin(cls.end_time)-toMin(cls.start_time))*60000);
    const diffSec=(start-now)/1000;

    /* timer */
    const t=b.querySelector(".timer");
    if(diffSec>0){
      t.textContent=fmt(diffSec);
      b.classList.remove("active");
    }else if(now<end){
      t.textContent=fmt((end-now)/1000);
      b.classList.add("active");
    }else{
      t.textContent="";
      b.classList.remove("active");
    }

    b.classList.remove("next");

    if(diffSec>0 && (!next||diffSec<next.diff)){
      next={block:b,start,end,diff:diffSec};
    }
  });

  /* TOP BAR */
  if(next){
    const total=(next.start-now)+next.diff*1000;
    const progress=1-(next.diff*1000/total);
    topBar.style.width=clamp(progress,0,1)*100+"%";
    topLabel.textContent=`Next: ${next.block.querySelector("b").textContent} in ${fmt(next.diff)}`;
    next.block.classList.add("next");
  }else{
    topBar.style.width="0%";
    topLabel.textContent="";
  }
},1000);

/* MODAL */
function openNew(s){
  active=null;activeSlot=s;
  modalTitle.textContent="Add class";
  mTitle.value="";mSection.value="";mRoom.value="";
  mStart.value=s.start;mEnd.value=s.end;
  modal.style.display="flex";
}
function openEdit(c){
  active=c;
  modalTitle.textContent="Edit class";
  mTitle.value=c.title;mSection.value=c.section||"";
  mRoom.value=c.room||"";mStart.value=c.start_time;mEnd.value=c.end_time;
  modal.style.display="flex";
}
window.closeModal=()=>modal.style.display="none";

/* SAVE / DELETE */
window.saveClass=async()=>{
  const {data:{user}}=await supabase.auth.getUser();
  const sec=mSection.value||null;
  const base={
    user_id:user.id,
    title:mTitle.value,
    section:sec,
    room:mRoom.value||null,
    start_time:mStart.value,
    end_time:mEnd.value,
    day:active?active.day:activeSlot.day,
    color:colorFromSection(sec)
  };
  active
    ?await supabase.from("classes").update(base).eq("id",active.id)
    :await supabase.from("classes").insert(base);
  closeModal();load();
};
window.deleteClass=async()=>{
  if(active){
    await supabase.from("classes").delete().eq("id",active.id);
    closeModal();load();
  }
};
</script>

</body>
</html>
