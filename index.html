<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CampusDude</title>

<style>
body{
  font-family:system-ui,sans-serif;
  background:linear-gradient(135deg,#667eea,#764ba2);
  margin:0;padding:20px;
}
.card{
  max-width:360px;margin:80px auto;
  background:#fff;border-radius:16px;
  padding:24px;box-shadow:0 20px 40px rgba(0,0,0,.25)
}
input{width:100%;padding:10px;margin-bottom:10px;border-radius:10px;border:1px solid #ddd}
button{
  width:100%;padding:10px;border-radius:999px;
  border:none;font-weight:700;background:#4f46e5;color:#fff;cursor:pointer
}
.link{font-size:13px;text-align:center;color:#4f46e5;cursor:pointer;margin-top:6px}
#app{display:none;color:#fff}
</style>
</head>

<body>

<!-- AUTH -->
<div id="authPage" class="card">
  <h2 id="authTitle">Login</h2>
  <input id="nameInput" placeholder="Your name" style="display:none">
  <input id="email" placeholder="Email">
  <input id="password" type="password" placeholder="Password">
  <button onclick="submitAuth()">Continue</button>
  <div class="link" onclick="toggleMode()" id="switchText">New here? Create an account</div>
  <div class="link" onclick="resetPassword()">Forgot password?</div>
</div>

<!-- RESET PASSWORD -->
<div id="resetPage" class="card" style="display:none">
  <h2>Reset password</h2>
  <input id="newPassword" type="password" placeholder="New password">
  <button onclick="updatePassword()">Update password</button>
</div>

<!-- APP -->
<div id="app">
  <h2 id="welcome"></h2>
  <button onclick="logout()">Logout</button>
</div>

<script type="module">
import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

const supabase = createClient(
  "https://uwjnbbmbxxodiwrleozc.supabase.co",
  "sb_publishable_OINdv3b3c9-SRUr7ngWVlA_iPXM89of"
);

let authMode="login";

/* TOGGLE */
window.toggleMode=()=>{
  authMode=authMode==="login"?"signup":"login";
  authTitle.textContent=authMode==="login"?"Login":"Create account";
  nameInput.style.display=authMode==="signup"?"block":"none";
  switchText.textContent=authMode==="login"
    ?"New here? Create an account":"Already have an account? Login";
};

/* LOGIN / SIGNUP */
window.submitAuth=async()=>{
  if(authMode==="signup"){
    const { error } = await supabase.auth.signUp({
      email:email.value,
      password:password.value,
      options:{data:{full_name:nameInput.value}}
    });
    if(error) return alert(error.message);
    alert("Account created. Now login.");
    toggleMode();
    return;
  }

  const { data, error } = await supabase.auth.signInWithPassword({
    email:email.value,password:password.value
  });
  if(error) return alert(error.message);
  if(!data.session) return alert("No session");

  initApp();
};

/* RESET EMAIL */
window.resetPassword=async()=>{
  if(!email.value) return alert("Enter email first");
  const { error } = await supabase.auth.resetPasswordForEmail(
    email.value,
    { redirectTo: location.origin }
  );
  if(error) return alert(error.message);
  alert("Password reset email sent");
};

/* UPDATE PASSWORD */
window.updatePassword=async()=>{
  const { error } = await supabase.auth.updateUser({
    password:newPassword.value
  });
  if(error) return alert(error.message);
  alert("Password updated");
  location.reload();
};

/* INIT APP */
async function initApp(){
  authPage.style.display="none";
  app.style.display="block";
  const { data:{ user } } = await supabase.auth.getUser();
  welcome.textContent=`ðŸ‘‹ Hi, ${user.user_metadata.full_name||"Student"}`;
}

/* LOGOUT */
window.logout=async()=>{
  await supabase.auth.signOut();
  location.reload();
};

/* SESSION CHECK (PASSWORD RESET HANDLER) */
const { data:{ session } } = await supabase.auth.getSession();
if(session){
  if(location.hash.includes("type=recovery")){
    authPage.style.display="none";
    resetPage.style.display="block";
  } else {
    initApp();
  }
}
</script>

</body>
</html>
